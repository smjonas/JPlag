<?xml version="1.0" encoding="UTF-8"?>
<scxml xmlns="http://www.w3.org/2005/07/scxml" version="1.0" datamodel="ecmascript" name="Rob">
	<datamodel>
		<data expr="0" id="stopsAt" />
		<data expr="6" id="remainingCapacity" />
		<data expr="0" id="numPassengers" />
		<data expr="false" id="stopped" />
		<data expr="0" id="nowAt" />
		<data expr="0" id="currentStop" />
		<data expr="false" id="obstructed" />
	</datamodel>
	<state id="main_region">
		<initial>
			<transition target="Trolley" type="internal">
			</transition>
		</initial>
		<parallel id="Trolley">
			<state id="r1">
				<initial>
					<transition target="normal" type="internal">
					</transition>
				</initial>
				<state id="normal">
					<initial>
						<transition target="ArrivalAtStation" type="internal">
						</transition>
					</initial>
					<state id="ArrivalAtStation">
						<initial>
							<transition target="OpenDoors" type="internal">
							</transition>
						</initial>
						<state id="OpenDoors">
							<onentry>
								<send event="OpenDoors_t_0_timeEvent_0" delay="2s"/>
							</onentry>
							<onexit>
								<cancel sendid="OpenDoors_t_0_timeEvent_0" />
							</onexit>
							<onentry>
								<send event="openDoors">
								</send>
								<send event="tempOpenDoors">
								</send>
							</onentry>
							<transition event="OpenDoors_t_0_timeEvent_0"  target="ArrivalAtStation.choice_0">
								 <assign location="stopsAt" expr="stopsAt &amp; ~(1 &lt;&lt; currentStop)"/>
								<send event="refreshUI">
								</send>
							</transition>
						</state>
						<state id="DoorsOpenForTwoSeconds">
						</state>
						<state id="ArrivalAtStation.choice_0">
							<transition  cond="stopsAt != 0" target="DepartureToStation">
							</transition>
							<transition   target="DoorsOpenForTwoSeconds">
							</transition>
						</state>
					</state>
					<state id="DepartureToStation">
						<initial>
							<transition target="CloseDoors" type="internal">
							</transition>
						</initial>
						<state id="CloseDoors">
							<initial>
								<transition target="StartBoardTimer" type="internal">
								</transition>
							</initial>
							<state id="StartBoardTimer">
								<onentry>
									<send event="startDoorsSignal">
									</send>
									<send event="tempStartDoorsSignal">
									</send>
								</onentry>
								<transition event="go"  target="BoardingDone">
								</transition>
							</state>
							<state id="BoardingDone">
								<onentry>
									<send event="BoardingDone_t_0_timeEvent_0" delay="1s"/>
								</onentry>
								<onexit>
									<cancel sendid="BoardingDone_t_0_timeEvent_0" />
								</onexit>
								<onentry>
									<send event="stopDoorsSignal">
									</send>
									<send event="closeDoors">
									</send>
									<send event="tempCloseDoors">
									</send>
									 <assign location="nowAt" expr="5"/>
								</onentry>
								<transition event="BoardingDone_t_0_timeEvent_0"  target="Accelerate">
								</transition>
							</state>
						</state>
						<state id="Accelerate">
							<onentry>
								<send event="setTargetSpeed">
								<content expr="24" />
								</send>
							</onentry>
							<transition event="atTargetSpeed"  target="CheckApproachingStations">
							</transition>
						</state>
						<state id="CheckApproachingStations">
							<transition  cond="approachingStation &amp;&amp; (stopsAt &amp; (1 &lt;&lt; _event.data)) != 0" target="Brake">
								 <assign location="currentStop" expr="_event.data"/>
							</transition>
						</state>
						<state id="Brake">
							<onentry>
								<send event="setTargetSpeed">
								<content expr="0" />
								</send>
							</onentry>
							<transition event="atTargetSpeed"  target="Standstill">
							</transition>
						</state>
						<state id="Standstill">
							<onentry>
								<send event="startArrival">
								</send>
							</onentry>
						</state>
						<transition event="startArrival"  target="WaitOneSecondAtArrival">
						</transition>
					</state>
					<state id="WaitOneSecondAtArrival">
						<onentry>
							 <assign location="nowAt" expr="currentStop"/>
						</onentry>
					</state>
					<transition event="startEmergency"  target="emergency">
					</transition>
				</state>
				<state id="emergency">
					<initial>
						<transition target="emergency.choice_0" type="internal">
						</transition>
					</initial>
					<state id="setBrake">
						<onentry>
							<send event="setTargetSpeed">
							<content expr="0" />
							</send>
						</onentry>
						<transition event="atTargetSpeed"  target="braked">
						</transition>
					</state>
					<state id="braked">
						<onentry>
							<send event="openDoors">
							</send>
							<send event="tempOpenDoors">
							</send>
						</onentry>
						<transition event="stopEmergency"  target="emergency.choice_1">
						</transition>
					</state>
					<state id="emergency.choice_0">
						<transition  cond="nowAt != 5" target="braked">
							 <assign location="stopped" expr="true"/>
						</transition>
						<transition   target="setBrake">
							 <assign location="stopped" expr="false"/>
						</transition>
					</state>
					<state id="emergency.choice_1">
						<transition  cond="stopped == false" target="DepartureToStation">
						</transition>
					</state>
				</state>
			</state>
			<state id="obstructionTimer">
				<initial>
					<transition target="noObstruct" type="internal">
					</transition>
				</initial>
				<state id="noObstruct">
					<onentry>
						 <assign location="obstructed" expr="false"/>
						<send event="unobstruct">
						</send>
					</onentry>
					<transition event="actualBoard"  target="Obstruct">
					</transition>
				</state>
				<state id="Obstruct">
					<onentry>
						 <assign location="obstructed" expr="true"/>
						<send event="obstruct">
						</send>
					</onentry>
				</state>
			</state>
			<state id="closeDoorsTimer">
				<initial>
					<transition target="noTimer" type="internal">
					</transition>
				</initial>
				<state id="noTimer">
				</state>
				<state id="Timer">
					<onentry>
						<send event="Timer_t_0_timeEvent_0" delay="1s"/>
					</onentry>
					<onexit>
						<cancel sendid="Timer_t_0_timeEvent_0" />
					</onexit>
					<transition event="Timer_t_0_timeEvent_0"  target="noTimer">
						<send event="go">
						</send>
					</transition>
					<transition event="obstruct"  target="ObstructedDoor">
					</transition>
				</state>
				<state id="ObstructedDoor">
					<transition event="unobstruct"  target="Timer">
					</transition>
				</state>
			</state>
			<state id="Boarding">
				<initial>
					<transition target="BoardTimerOff" type="internal">
					</transition>
				</initial>
				<state id="BoardTimerOff">
					<onentry>
						<send event="refreshUI">
						</send>
					</onentry>
					<transition event="tempOpenDoors"  target="ArrivalBoardTimerOn">
					</transition>
				</state>
				<state id="ArrivalBoardTimerOn">
					<onentry>
						<send event="refreshUI">
						</send>
					</onentry>
					<transition event="tempCloseDoors"  target="BoardTimerOff">
					</transition>
					<transition event="board" cond="(remainingCapacity &gt; 0) &amp;&amp; (obstructed == false)" target="ArrivalBoardTimerOn">
						 <assign location="numPassengers" expr="numPassengers + 1"/>
						 <assign location="remainingCapacity" expr="remainingCapacity - 1"/>
						<send event="refreshUI">
						</send>
						<send event="actualBoard">
						</send>
					</transition>
					<transition event="unboard" cond="(numPassengers &gt; 0) &amp;&amp; (obstructed == false)" target="ArrivalBoardTimerOn">
						 <assign location="numPassengers" expr="numPassengers - 1"/>
						 <assign location="remainingCapacity" expr="remainingCapacity + 1"/>
						<send event="refreshUI">
						</send>
						<send event="actualBoard">
						</send>
					</transition>
				</state>
			</state>
			<state id="r3">
				<initial>
					<transition target="Board" type="internal">
					</transition>
				</initial>
				<state id="Board">
					<transition event="requestStop"  target="Board">
						 <assign location="stopsAt" expr="stopsAt | (1 &lt;&lt; _event.data)"/>
						<send event="refreshUI">
						</send>
					</transition>
				</state>
			</state>
		</parallel>
	</state>
</scxml>
