<?xml version="1.0" encoding="UTF-8"?>
<scxml xmlns="http://www.w3.org/2005/07/scxml" version="1.0" datamodel="ecmascript" name="Max">
	<datamodel>
		<data expr="false" id="toiletBreak" />
		<data expr="0" id="shiftType" />
		<data expr="" id="action" />
	</datamodel>
	<state id="main_region">
		<initial>
			<transition target="Home" type="internal">
			</transition>
		</initial>
		<state id="Home">
			<onentry>
				<script>
					setMsg('At home.');
				</script>
				<script>
					shiftsHide();
				</script>
			</onentry>
			<transition event="employee.goToWork"  target="Work">
			</transition>
		</state>
		<state id="Work">
			<initial>
				<transition target="Idle" type="internal">
				</transition>
			</initial>
			<state id="Idle">
				<onentry>
					<script>
						setMsg('At work.');
					</script>
					<script>
						pushMsg();
					</script>
				</onentry>
				<onentry>
					<if cond="getEnergy(); &gt;= 25">
					<script>
						setMsg('Selected shift will start soon!');
					</script>
					<script>
						shiftsShow();
					</script>
					 <assign location="shiftType" expr="getRandomInteger(3);"/>
					<script>
						shiftHighlightAssigned(shiftType);
					</script>
					</if>
				</onentry>
				<onentry>
					<if cond="getEnergy(); &lt; 25">
					<script>
						setMsg('Go home! You're too tired.');
					</script>
					</if>
				</onentry>
				<transition event ="employee.shiftClicked"  type="internal" >
					 <assign location="shiftType" expr="_event.data"/>
					<script>
						shiftHighlightAssigned(shiftType);
					</script>
				</transition>
				<onentry>
					<send event="Idle_timeEvent_0" delay="4s"/>
				</onentry>
				<transition event="Idle_timeEvent_0" cond="getEnergy(); &gt;= 25" type="internal">
					<script>
						shiftHighlightActive(shiftType);
					</script>
					<send event="startShift">
					</send>
				</transition>
				<onexit>
					<cancel sendid="Idle_timeEvent_0" />
				</onexit>
				<transition event="startShift"  target="Shift">
				</transition>
			</state>
			<parallel id="Shift">
				<onentry>
					<send event="Shift_timeEvent_0" delay="10s"/>
				</onentry>
				<transition event="Shift_timeEvent_0"  type="internal">
					<send event="endShift">
					</send>
				</transition>
				<onexit>
					<cancel sendid="Shift_timeEvent_0" />
				</onexit>
				<state id="Main">
					<initial>
						<transition target="Shift.Main.choice_0" type="internal">
						</transition>
					</initial>
					<state id="Loading">
						<onentry>
							<script>
								setMsg('Working loading shift.');
							</script>
							<script>
								pushMsg();
							</script>
						</onentry>
						<initial>
							<transition target="AtStock" type="internal">
							</transition>
						</initial>
						<state id="AtStockCarrying">
							<onentry>
								<script>
									setActions('Walk');
								</script>
								<script>
									setMsg('At stock, carrying finished product.');
								</script>
							</onentry>
							<transition event="walk"  target="AtTruckCarrying">
							</transition>
						</state>
						<state id="AtStock">
							<onentry>
								<script>
									setActions('Walk,Pick up,Toilet break');
								</script>
								<script>
									setMsg('In stock.');
								</script>
							</onentry>
							<transition event ="startToiletBreak"  type="internal" >
								<send event="goToToilet">
								</send>
							</transition>
							<transition event="walk"  target="AtTruck">
							</transition>
							<transition event="pickup" cond="getFinished(); &gt; 0" target="AtStockCarrying">
								<script>
									increaseFinished(-1);
								</script>
							</transition>
						</state>
						<state id="AtTruck">
							<onentry>
								<script>
									setActions('Walk');
								</script>
								<script>
									setMsg('At truck.');
								</script>
							</onentry>
							<transition event="walk"  target="AtStock">
							</transition>
						</state>
						<state id="AtTruckCarrying">
							<onentry>
								<script>
									setActions('Walk,Drop');
								</script>
								<script>
									setMsg('At truck, carrying finished product.');
								</script>
							</onentry>
							<transition event="drop"  target="AtTruck">
							</transition>
							<transition event="walk"  target="AtStockCarrying">
							</transition>
						</state>
						<transition event="goToToilet"  target="Toilet_Break">
						</transition>
					</state>
					<state id="Unloading">
						<onentry>
							<script>
								setMsg('Working unloading shift.');
							</script>
							<script>
								pushMsg();
							</script>
						</onentry>
						<initial>
							<transition target="AtStock" type="internal">
							</transition>
						</initial>
						<state id="AtStock">
							<onentry>
								<script>
									setActions('Walk,Toilet break');
								</script>
								<script>
									setMsg('In stock.');
								</script>
							</onentry>
							<transition event ="startToiletBreak"  type="internal" >
								<send event="goToToilet">
								</send>
							</transition>
							<transition event="walk"  target="AtTruck">
							</transition>
						</state>
						<state id="AtTruck">
							<onentry>
								<script>
									setActions('Walk,Pick up');
								</script>
								<script>
									setMsg('At truck.');
								</script>
							</onentry>
							<transition event="walk"  target="AtStock">
							</transition>
							<transition event="pickup"  target="AtTruckCarrying">
							</transition>
						</state>
						<state id="AtTruckCarrying">
							<onentry>
								<script>
									setActions('Walk');
								</script>
								<script>
									setMsg('At truck, carrying material.');
								</script>
							</onentry>
							<transition event="walk"  target="AtStockCarrying">
							</transition>
						</state>
						<state id="AtStockCarrying">
							<onentry>
								<script>
									setActions('Walk,Drop');
								</script>
								<script>
									setMsg('At stock, carrying material.');
								</script>
							</onentry>
							<transition event="walk"  target="AtTruckCarrying">
							</transition>
							<transition event="drop"  target="AtStock">
								<script>
									increaseMaterial(1);
								</script>
							</transition>
						</state>
						<transition event="goToToilet"  target="Toilet_Break">
						</transition>
					</state>
					<state id="Shift.Main.choice_0">
						<transition  cond="shiftType == 1" target="Assembly">
						</transition>
						<transition  cond="shiftType == 0" target="Unloading">
						</transition>
						<transition   target="Loading">
						</transition>
					</state>
					<state id="Assembly">
						<onentry>
							<script>
								setMsg('Working assembly shift.');
							</script>
							<script>
								pushMsg();
							</script>
						</onentry>
						<initial>
							<transition target="AtAssembly" type="internal">
							</transition>
						</initial>
						<state id="AtAssembly">
							<onentry>
								<script>
									setActions('Assemble');
								</script>
							</onentry>
							<transition event ="assemble" cond="getMaterial(); &gt; 0" type="internal" >
								<script>
									increaseFinished(1);
								</script>
								<script>
									increaseMaterial(-1);
								</script>
							</transition>
						</state>
					</state>
					<state id="Toilet_Break">
						<onentry>
							 <assign location="toiletBreak" expr="true"/>
							<script>
								pushMsg();
							</script>
							<script>
								setMsg('Toilet break!');
							</script>
							<script>
								setActions('Done');
							</script>
						</onentry>
						<onexit>
							 <assign location="toiletBreak" expr="false"/>
							<script>
								popMsg();
							</script>
						</onexit>
						<transition event="endToiletBreak"  target="Shift.Main.choice_0">
							<script>
								popMsg();
							</script>
						</transition>
					</state>
				</state>
				<state id="Energy">
					<initial>
						<transition target="EnergyManagement" type="internal">
						</transition>
					</initial>
					<state id="EnergyManagement">
						<onentry>
							<send event="EnergyManagement_timeEvent_0" delay="1s"/>
						</onentry>
						<transition event="EnergyManagement_timeEvent_0" cond="!toiletBreak" type="internal">
							<send event="drainEnergy">
							</send>
						</transition>
						<onexit>
							<cancel sendid="EnergyManagement_timeEvent_0" />
						</onexit>
						<transition event="drainEnergy"  target="EnergyManagement">
							<script>
								increaseEnergy(-2);
							</script>
						</transition>
						<transition event="endToiletBreak"  target="EnergyManagement">
						</transition>
					</state>
				</state>
				<state id="Listener">
					<initial>
						<transition target="Idle" type="internal">
						</transition>
					</initial>
					<state id="Idle">
						<transition event="ui.actionPressed"  target="ButtonPressed">
							 <assign location="action" expr="_event.data"/>
						</transition>
					</state>
					<state id="ButtonPressed">
						<onentry>
							<send event="ButtonPressed_timeEvent_0" delay="500ms"/>
						</onentry>
						<transition event="ButtonPressed_timeEvent_0" cond="action == 'Pick up'" type="internal">
							<send event="pickup">
							</send>
						</transition>
						<onexit>
							<cancel sendid="ButtonPressed_timeEvent_0" />
						</onexit>
						<onentry>
							<send event="ButtonPressed_timeEvent_1" delay="500ms"/>
						</onentry>
						<transition event="ButtonPressed_timeEvent_1" cond="action == 'Drop'" type="internal">
							<send event="drop">
							</send>
						</transition>
						<onexit>
							<cancel sendid="ButtonPressed_timeEvent_1" />
						</onexit>
						<onentry>
							<send event="ButtonPressed_timeEvent_2" delay="500ms"/>
						</onentry>
						<transition event="ButtonPressed_timeEvent_2" cond="action == 'Walk'" type="internal">
							<send event="walk">
							</send>
						</transition>
						<onexit>
							<cancel sendid="ButtonPressed_timeEvent_2" />
						</onexit>
						<onentry>
							<send event="ButtonPressed_timeEvent_3" delay="500ms"/>
						</onentry>
						<transition event="ButtonPressed_timeEvent_3" cond="action == 'Assemble'" type="internal">
							<send event="assemble">
							</send>
						</transition>
						<onexit>
							<cancel sendid="ButtonPressed_timeEvent_3" />
						</onexit>
						<onentry>
							<send event="ButtonPressed_timeEvent_4" delay="500ms"/>
						</onentry>
						<transition event="ButtonPressed_timeEvent_4" cond="action == 'Toilet break'" type="internal">
							<send event="startToiletBreak">
							</send>
						</transition>
						<onexit>
							<cancel sendid="ButtonPressed_timeEvent_4" />
						</onexit>
						<onentry>
							<send event="ButtonPressed_timeEvent_5" delay="500ms"/>
						</onentry>
						<transition event="ButtonPressed_timeEvent_5" cond="action == 'Done'" type="internal">
							<send event="endToiletBreak">
							</send>
						</transition>
						<onexit>
							<cancel sendid="ButtonPressed_timeEvent_5" />
						</onexit>
						<transition event="ui.actionReleased"  target="Idle">
						</transition>
					</state>
				</state>
				<transition event="endShift"  target="Idle">
					<script>
						increasePay(10);
					</script>
					<script>
						popMsg();
					</script>
					<script>
						popMsg();
					</script>
					<script>
						setActions('');
					</script>
				</transition>
			</parallel>
			<transition event="employee.goHome"  target="Home">
				<script>
					popMsg();
				</script>
				<script>
					increaseEnergy(50);
				</script>
			</transition>
		</state>
	</state>
</scxml>
